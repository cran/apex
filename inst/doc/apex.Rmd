---
title: "Phylogenetic Methods for Multiple Gene Data"
author: "Thibaut Jombart"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{apex: Phylogenetic Methods for Multiple Gene Data.}
 \usepackage[utf8]{inputenc}
---


```{r setup, echo=FALSE}
# set global chunk options: images will be 7x5 inches
knitr::opts_chunk$set(fig.width=7, fig.height=10, fig.path="figs/")
options(digits = 4)
```

*apex*: Phylogenetic Methods for Multiple Gene Data
=================================================
*apex* implements some new classes to handle DNA sequences from different genes and individuals.
It implements new classes extending object classes from *ape* and *phangorn* to store multiple gene data, and some useful wrappers mimicking existing functionalities for multiple genes.
This document provides an overview of the package's content.


Installing *apex*
-------------
To install the development version from github:
```{r install, eval=FALSE}
library(devtools)
install_github("thibautjombart/apex")
```

The stable version can be installed from CRAN using:
```{r install2, eval=FALSE}
install.packages("apex")
```

Then, to load the package, use:
```{r load}
library("apex")
```


New object classes
------------------
Two new classes of object extend existing data structure for multiple genes:
* **multidna:** based on *ape*'s `DNAbin` class
* **multiphyDat:** based on *phangorn*'s `phyDat` class

###  multidna
This formal (S4) class can be seen as a multi-gene extension of *ape*'s `DNAbin` class.
Data is stored as a list of DNAbin objects, with additional slots for extra information.
The class definition can be obtained by:
```r
getClassDef("multidna")
```
* **@dna**: list of `DNAbin` matrices, with matching rows
* **@labels**: labels of the individuals (rows of the matrices in `dna`)
* **@n.ind**: the number of individuals
* **@n.seq**: the total number of sequences in the dataset
* **@ind.info**: an optional dataset storing individual metadata 
* **@gene.info**: an optional dataset storing gene metadata 

Any of these slots can be accessed using `@` (see example below).

New `multidna` objects can be created via two ways:

1. using the constructor `new("multidna", ...)`
2. reading data from files (see section on 'importing data' below)

We illustrate the use of the constructor below (see `?new.multidna`) for more information.
We use *ape*'s dataset *woodmouse*, which we artificially split in two 'genes', keeping the first 500 nucleotides for the first gene, and using the rest as second gene. Note that the individuals need not match across different genes: matching is handled by the constructor.

```{r class}
## empty object
new("multidna")

## using a list of genes as input
data(woodmouse)
genes <- list(gene1=woodmouse[,1:500], gene2=woodmouse[,501:965])
x <- new("multidna", genes)
x

## access the various slots
x@labels
x@n.ind
class(x@dna) # this is a list
names(x@dna) # names of the genes
x@dna[[1]] # first gene
x@dna[[2]] # second gene

## compare the input dataset and the new multidna
par(mfrow=c(3,1), mar=c(6,6,2,1))
image(woodmouse)
image(x@dna[[1]])
image(x@dna[[2]])

## same but with missing sequences and wrong order
genes <- list(gene1=woodmouse[,1:500], gene2=woodmouse[c(5:1,14:15),501:965])
x <- new("multidna", genes)
x
par(mar=c(6,6,2,1))
plot(x)
```



Importing data
--------------
Two simple functions permit to import data from multiple alignements into `multidna` objects:
* **read.multidna:** reads multiple DNA alignments with various formats
* **read.multiFASTA:** same for FASTA files

Both functions rely on the single-gene counterparts in *ape* and accept the same arguments.
Each file should contain data from a given gene, where sequences should be named after individual labels only.
Here is an example using a dataset from *apex*:
```{r readfiles}
## get address of the file within apex
files <- dir(system.file(package="apex"),patter="patr", full=TRUE)
files # this will change on your computer

## read these files
x <- read.multiFASTA(files)
x
names(x@dna) # names of the genes
par(mar=c(6,11,2,1))
plot(x)
```

Additionally:
* **read.multiphyDat:** reads multiple DNA alignments with various formats.
The arguments are the same as the single-gene `read.phyDat` in *phangorn*:
```{r readfiles phyDat}
z <- read.multiphyDat(files, format="fasta")
z
```


Handling data
--------------
Several functions facilitate data handling:
* **concatenate:** concatenate several genes into a single DNAbin or phyDat matrix
* **x[i,j]:** subset x by individuals (i) and/or genes (j)

Example code:
```{r handling}
files <- dir(system.file(package="apex"),patter="patr", full=TRUE)
files

## read files
x <- read.multiFASTA(files)
x
par(mar=c(6,11,2,1))
plot(x)

## subset
plot(x[1:3,2:4])
```

```{r concat, fig.width=12, fig.height=7}
## concatenate
y <- concatenate(x)
y
par(mar=c(5,8,2,1))
image(y)

## concatenate multiphyDat object
z <- multidna2multiphyDat(x)
u <- concatenate(z)
u
tree <- pratchet(u, trace=0)
plot(tree, "u")
```

Building trees
---------------
One can build neighbor joining trees from for each gene or pooled genes for multidna objects
```{r gettree}
## make trees, default parameters
trees <- getTree(x)
trees
```
```{r hidePlotMultiPhylo, echo=TRUE,eval=FALSE}
plot(trees, 4, type="unrooted")
```
```{r plotMultiPhylo, echo=FALSE,eval=TRUE}
par(mfrow=c(2,2)); for(i in 1:length(trees))plot(trees[[i]])
```
```{r plotPhyloSingle, echo=FALSE,eval=TRUE}
## make one single tree based on concatenated genes
tree <- getTree(x, pool=TRUE)
tree
par(mfrow=c(1,1))
plot(tree, type="unrooted")
```

or can uses functions from `phangorn` to estimate with maximum likelihood models
```{r pmlPart}
pp <- pmlPart(bf ~ edge + nni, z, control = pml.control(trace = 0))
pp
trees <- pmlPart2multiPhylo(pp)
```
```{r hidePlotMultiPhylo2, echo=TRUE,eval=FALSE}
plot(trees, 4)
```
```{r plotPmlPart, echo=FALSE,eval=TRUE}
par(mfrow=c(2,2)); for(i in 1:length(trees))plot(trees[[i]])
```

Exporting data
---------------
The following functions enable the export from *apex* to other packages:
* **multidna2genind:** concatenates genes and export to genind
* **multiphyDat2genind:** does the same for multiphyDat object
This is illustrated below:
```{r export}
## find source files in apex
files <- dir(system.file(package="apex"),patter="patr", full=TRUE)

## import data
x <- read.multiFASTA(files)
x

## export to genind
obj1 <- multidna2genind(x)
obj1

obj2 <- multiphyDat2genind(x)
identical(obj1, obj2)
```
